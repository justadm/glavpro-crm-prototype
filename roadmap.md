# План реализации тестового задания (Joomla + PHP)

## 0. Цели и критерии готовности
- Реализован прототип CRM-стадий с жесткими ограничениями переходов.
- UI карточки компании содержит текущую стадию, доступные действия, инструкцию, историю событий.
- Логика стадий проверяема тестами, есть журнал событий.
- README включает архитектуру, модель данных, тесты, AI-workflow, рекомендации по масштабированию.

## 1. Выбор формата реализации
- Формат: компонент Joomla.
- Обоснование: собственные таблицы, контроллеры, бизнес-логика стадий, удобная маршрутизация и тестируемость.

## 2. Требования к окружению (локально/хостинг)
### 2.1 Локально
- PHP 8.1+ (предпочтительно 8.1/8.2), MySQL 8+ или MariaDB 10.4+.
- Joomla 4/5 (указать точную версию в README).
- Включенные расширения PHP: mbstring, mysqli/pdo_mysql, json, intl, xml, curl, zip.
- Доступ к CLI для запуска тестов.
- Вариант: Docker (если используем), тогда 1–2 команды старта через `docker compose`.

### 2.2 Хостинг
- PHP 8.1+ и MySQL 8+ (или MariaDB 10.4+), доступ к созданию таблиц.
- Доступ к установке Joomla и размещению компонента.
- Возможность запускать тесты (CLI) или документированный обход (если CLI недоступен).

## 3. Модель данных
### 3.1 Таблицы
- `companies`
  - id (PK)
  - name
  - stage_code (индекс)
  - created_at, updated_at
- `crm_events`
  - id (PK)
  - company_id (FK)
  - event_type (индекс)
  - payload (JSON)
  - created_at (индекс)

### 3.2 Индексы
- `crm_events(company_id, event_type, created_at)`
- `companies(stage_code)`

### 3.3 События (минимум)
- attempt_contact
- lpr_call_done
- discovery_filled
- demo_scheduled
- demo_done
- invoice_issued
- payment_received
- first_certificate_issued

## 4. Логика стадий (конечный автомат)
- Список стадий: Ice → Touched → Aware → Interested → demo_planned → Demo_done → Committed → Customer → Activated.
- Доступные действия и переходы определяются наличием событий.
- Все кнопки UI зависят от функции `getAvailableActions()`.
- Переходы стадий выполняются только через `tryAdvanceStage()` с проверкой событий.

## 5. UI карточки компании
- Блок: текущая стадия.
- Блок: список доступных действий (кнопки).
- Блок: инструкция/скрипт для менеджера (статический или привязанный к стадии).
- Блок: история событий (таблица/лента).

## 6. Реализация компонента
### 6.1 Структура
- Controller: обработка действий (создание события, попытка перехода стадии).
- Model: доступ к данным и вычисление условий.
- View: отображение карточки компании.

### 6.2 Механика действий
- Нажатие кнопки → создается событие.
- После события пересчитывается стадия компании.
- История событий обновляется.

## 7. Тестирование
### 7.1 Unit-тесты
- Проверка доступности действий для каждой стадии.
- Проверка запрета перехода без обязательных событий.
- Проверка корректного перехода при наличии событий.

### 7.2 Интеграционные
- UI действие → запись события → смена стадии.

### 7.3 Демонстрация цикла
- Описать/зафиксировать один баг → исправление → зелёные тесты.

## 8. AI-workflow (обязательная часть)
- Инструменты: перечислить использованные.
- Процесс: декомпозиция задач, промпты, проверка результатов.
- Контроль рисков: проверка логики, отсутствие галлюцинаций, лицензии.
- Где AI дал выигрыш: код/тесты/README/UX-тексты.

## 9. README
- Обоснование выбора компонента.
- Инструкция запуска (1–2 команды).
- Архитектура и модель данных.
- Описание логики стадий.
- Тесты + лог прогона.
- AI-workflow.
- Идеи улучшений.

## 10. Финальная проверка
- Все требования ТЗ покрыты.
- UI соответствует пункту “Карточка компании”.
- Логика стадий строго по acceptance criteria.
- Тесты запускаются и проходят.

---

# 1) Матрица Given/When/Then по стадиям

## C1 Touched
- Given нет разговоров с ЛПР
  When менеджер пытается: завести заявку / отправить КП / планировать демо / показать демо
  Then действие недоступно
- Given разговор с ЛПР зафиксирован (событие `lpr_call_done`)
  When система пересчитывает стадию
  Then следующая стадия может стать `Aware`
- Given есть разговор с ЛПР
  When менеджер открывает карточку
  Then доступна только кнопка звонка, а после отвеченного вызова — форма комментария и дискавери

## C2 Aware
- Given есть разговор с ЛПР
  When менеджер пытается: планировать демо / показать демо
  Then действие недоступно
- Given разговор с ЛПР и заполнена дискавери (`discovery_filled`)
  When система пересчитывает стадию
  Then следующая стадия может стать `Interested`
- Given стадия Aware
  When менеджер открывает карточку
  Then доступна форма дискавери

## W1 Interested
- Given заполнена дискавери
  When менеджер пытается: завести заявку / отправить КП
  Then действие недоступно
- Given заполнена дискавери
  When менеджер планирует демо (событие `demo_scheduled` с датой/временем)
  Then следующая стадия может стать `demo_planned`
- Given стадия Interested
  When менеджер открывает карточку
  Then доступна кнопка планирования демо

## W2 demo_planned
- Given есть дата и время демо
  When менеджер пытается: завести заявку / отправить КП
  Then действие недоступно
- Given есть запланированное демо
  When зафиксирован переход по ссылке демо (`demo_done`)
  Then следующая стадия может стать `Demo_done`
- Given стадия demo_planned
  When менеджер открывает карточку
  Then доступна кнопка “провести демо” (по ссылке)

## W3 Demo_done
- Given есть лог “демо проведено” менее 60 дней назад
  When менеджер открывает карточку
  Then доступны кнопка заведения заявки и кнопка отправки КП
- Given нет события `demo_done` или демо старше 60 дней
  When менеджер пытается завести заявку/отправить КП
  Then действия недоступны
- Given есть `invoice_issued`
  When система пересчитывает стадию
  Then следующая стадия может стать `Committed`

## H1 Committed
- Given есть счёт (`invoice_issued`)
  When система пересчитывает стадию
  Then стадия `Committed`
- Given нет оплаты
  When менеджер пытается перейти в `Customer`
  Then переход недоступен

## H2 Customer
- Given есть оплата (`payment_received`)
  When система пересчитывает стадию
  Then стадия `Customer`
- Given нет первого удостоверения
  When менеджер пытается перейти в `Activated`
  Then переход недоступен

## A1 Activated
- Given есть одно удостоверение (`first_certificate_issued`)
  When система пересчитывает стадию
  Then стадия `Activated`

---

# 2) Список тест‑кейсов и приоритеты

## P0 (критично)
- Нельзя перепрыгивать стадии без обязательных событий.
- Доступность кнопок строго по условиям входа.
- Корректный переход при наличии нужных событий.

## P1 (важно)
- Логика “демо проведено < 60 дней”.
- История событий отображается в правильном порядке.
- Событие создаётся при каждом действии UI.

## P2 (желательно)
- Обработка повторных событий (идемпотентность отображения).
- Корректная работа при отсутствии событий.

---

# 3) Шаблон README под сдачу

## Проект
Прототип CRM‑воронки для Joomla. Реализована карточка компании и логика стадий с запретом “перепрыгивания”.

## Запуск
- Локально: `composer install` + запуск Joomla/DB (указать точные команды).
- Тесты: `vendor/bin/phpunit`.

## Архитектура
- Компонент Joomla с собственными таблицами.
- Стадии управляются через конечный автомат и журнал событий.

## Модель данных
- `companies` и `crm_events`.
- Индексы: `crm_events(company_id, event_type, created_at)` и `companies(stage_code)`.

## Логика стадий
- Полный список стадий и требований переходов.
- Доступность действий определяется наличием событий.

## Тестирование
- Unit‑тесты на переходы и кнопки.
- Интеграционные на полный сценарий.
- Пример цикла “баг → фикс → зелёные тесты”.

## AI‑workflow
- Инструменты, процесс, контроль качества и где AI дал выигрыш.

## Идеи улучшений
- Расширение аудита событий, роль‑бэйзд доступ, синхронизация интеграций.
