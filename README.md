# Glavpro CRM прототип

Прототип CRM-воронки (стадии + события) для Joomla. Реализована карточка компании, логика стадий и базовое тестовое покрытие.

## Обоснование формата
- Выбран компонент Joomla, потому что требуется отдельная модель данных, контроллеры, представления и удобная маршрутизация внутри админки.
- Компонент позволяет изолировать бизнес‑логику стадий и обеспечить тестируемость.

## Быстрый запуск
1. Установить Joomla 4/5.
2. Установить компонент из `/Users/just/Sites/главпро/component/com_glavpro_crm`.
3. Открыть админ-страницу компонента и список компаний.
4. Для демо-данных выполнить SQL из `/Users/just/Sites/главпро/component/com_glavpro_crm/administrator/components/com_glavpro_crm/sql/demo_seed.sql`.
5. Команды для тестов: `composer install` и `vendor/bin/phpunit --configuration phpunit.xml`.

## Демо-стенд (Docker)
- Инструкция: `/Users/just/Sites/главпро/deploy/README.md`.
- Запуск: `docker compose -f deploy/docker-compose.yml up -d`.
- Сборка ZIP компонента: `bash scripts/build_component_zip.sh`.

## Установка на хостинг
- Убедиться, что PHP 8.1+ и MySQL 8+ (или MariaDB 10.4+).
- Установить Joomla 4/5 на хостинг.
- Загрузить компонент как архив или папкой `component/com_glavpro_crm`.
- В админке Joomla выполнить установку компонента.
- При необходимости выполнить SQL демо-данных.
- Проверить доступ к странице админ‑компонента.

## Архитектура
- Компонент Joomla с собственными таблицами `#__glavpro_companies` и `#__glavpro_crm_events`.
- Логика стадий через `StageEngine` и таблицу событий.
- Переходы между стадиями доступны только при наличии обязательных событий.

## Модель данных
- `#__glavpro_companies`: компания + текущая стадия.
- `#__glavpro_crm_events`: журнал событий компании.

## Логика стадий
- Стадии: Ice → Touched → Aware → Interested → demo_planned → Demo_done → Committed → Customer → Activated.
- Условия переходов и ограничения соответствуют требованиям ТЗ.
- Доступность действий в карточке = запрет “перепрыгивания” стадий.

## Acceptance Criteria (Given/When/Then)
- Полная матрица в `/Users/just/Sites/главпро/acceptance.md`.

## Тесты
- Unit-тесты: `StageEngineTest`.
- Команды запуска: `composer install` и `vendor/bin/phpunit --configuration phpunit.xml`.

### Лог прогона
- Лог сохранен в `/Users/just/Sites/главпро/tests/test-log.txt`.

## AI-workflow
- Инструменты: AI‑ассистент Codex (ChatGPT).
- Процесс: декомпозиция задач → генерация каркаса кода и тестов → ручная проверка условий → корректировки.
- Контроль рисков: сверка правил стадий с ТЗ, проверка событий и условий переходов.
- Где AI дал выигрыш: ускорение разработки `StageEngine`, тестов, шаблонов документации.

## Масштабирование до ~10k компаний/день
- Индексы по `company_id`, `event_type`, `created_at`, а также по `stage_code` у компаний.
- Append‑only журнал событий, минимизация блокировок и обновлений в `companies`.
- Возможность фоновой агрегации стадий и кэширование чтения карточек.

## Цикл “баг → фикс → зелёные тесты”
- Баг: нельзя было перейти со стадии Ice на Touched после события `attempt_contact`.
- Коммит с тестом, который выявил баг: `743bc78`.
- Коммит с фиксом (добавлено правило перехода и действие): `611cb77`.
- Актуальный лог прогона тестов: `/Users/just/Sites/главпро/tests/test-log.txt`.

## Улучшения
- Полная интеграция с UI Joomla (формы и права доступа).
- Роли менеджеров и разграничение действий.
- Больше интеграционных тестов.
